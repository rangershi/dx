---
name: online-debug-guard
description: 在线调试安全护栏技能。用于排查数据库、Redis、服务配置等线上或准线上问题时，强制执行环境识别、模式校验和本地环境文件存在性检查，防止误连误操作。触发场景：用户提到在线调试、连库排查、查 Redis、生产环境排障、按指定环境排查问题。
---

# 在线调试安全护栏

## 概览

执行在线调试前先做硬性门禁，未通过即停止。仅在门禁通过后再进行排查动作，默认使用只读方式获取信息。

## 执行流程（必须按顺序）

1. 识别目标环境
2. 校验协作模式与环境文件
3. 门禁通过后执行调试

任一步失败都必须立即终止，不得继续后续步骤。

## 步骤 1：识别目标环境

只接受 `development`、`staging`、`production` 三种值。

如果用户调用技能时未显式给出环境：
- 先询问用户当前环境（只给这三个选项）。
- 若用户未回复或信息仍不明确，则默认 `development`，并明确告知本次按 `development` 执行。

如果用户给了其他环境名（例如 `prod1`、`test`）：
- 立即终止。
- 明确提示“环境无效，仅支持 development/staging/production”。

## 步骤 2：门禁校验

### 2.1 production 环境的模式限制

当环境是 `production` 时，必须先确认当前处于 `Plan` 模式。

如果不是 `Plan` 模式：
- 立即终止。
- 使用如下提示：

```text
已终止：当前为 production 环境，但会话不在 Plan 模式。
请切换到 Plan 模式后再继续在线调试。
```

### 2.2 环境文件存在性校验

将项目根目录作为基准，检查以下文件：
- `.env.${ENV_NAME}`
- `.env.${ENV_NAME}.local`

校验规则：
- 两个文件都必须存在。
- 若 `.env.${ENV_NAME}.local` 不存在，视为环境指定有误，立即终止。

终止提示模板：

```text
已终止：未找到 .env.${ENV_NAME}.local，判定环境指定有误。
请确认环境仅为 development/staging/production，且对应本地覆盖文件存在。
```

## 步骤 3：在线调试执行规范

门禁通过后，才允许执行调试。

调试时遵循：
- 默认只读：优先使用查询、检查、对比，不做写入。
- 允许使用环境文件中的连接信息访问数据库、Redis 等依赖来定位问题。
- 在未获用户明确授权前，禁止执行会改变状态的操作（例如写库、删键、迁移、重启、发布）。
- 输出结论时必须包含：目标环境、已通过的门禁项、关键证据、下一步建议。

## 标准开场模板

```text
开始在线调试前先执行安全门禁：
1) 确认环境（development/staging/production）
2) production 场景校验是否为 Plan 模式
3) 校验 .env.${ENV_NAME} 与 .env.${ENV_NAME}.local 是否存在
任一失败将立即终止，避免误操作。
```
