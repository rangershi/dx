{
  "dev": {
    "backend": {
      "command": "npx nx dev backend",
      "app": "backend",
      "ports": [3000],
      "description": "启动后端开发服务"
    },
    "front": {
      "command": "npx nx dev front",
      "app": "front",
      "ports": [3001],
      "description": "启动前端开发服务"
    },
    "admin": {
      "command": "npx nx dev admin-front",
      "app": "admin-front",
      "ports": [3500],
      "description": "启动管理后台开发服务"
    },
    "telegram-bot": {
      "command": "npx nx dev telegram-bot",
      "app": "telegram-bot",
      "ports": [3003],
      "description": "启动 Telegram Bot 开发服务 (Vercel Dev)"
    },
    "all": {
      "concurrent": true,
      "commands": ["dev.backend", "dev.front", "dev.admin"],
      "description": "同时启动所有开发服务",
      "interactive": true
    }
  },
  "build": {
    "backend": {
      "dev": {
        "command": "npx nx build backend --configuration=development",
        "app": "backend",
        "description": "构建后端(开发环境)"
      },
      "prod": {
        "command": "npx nx build backend --configuration=production",
        "app": "backend",
        "description": "构建后端(生产环境)"
      }
    },
    "shared": {
      "command": "npx nx build shared",
      "description": "构建共享包 @ai/shared",
      "skipEnvValidation": true
    },
    "front": {
      "dev": {
        "command": "npx nx build front --configuration=development",
        "app": "front",
        "description": "构建前端(开发环境)"
      },
      "prod": {
        "command": "npx nx run front:exportDist",
        "app": "front",
        "description": "构建并导出前端到 dist/front (生产环境)"
      }
    },
    "admin": {
      "dev": {
        "command": "npx nx build admin-front --configuration=development",
        "app": "admin-front",
        "description": "构建管理后台(开发环境)"
      },
      "prod": {
        "command": "npx nx build admin-front --configuration=production",
        "app": "admin-front",
        "description": "构建管理后台(生产环境)"
      }
    },
    "mobile": {
      "dev": {
        "command": "cd apps/front && APP_ENV=local NEXT_PUBLIC_APP_ENV=local NEXT_CAPACITOR_BUILD=1 pnpm build:mobile && LANG=en_US.UTF-8 npx cap sync android && cd android && ./gradlew assembleDebug && cd .. && mkdir -p public/apk && cp android/app/build/outputs/apk/debug/app-debug.apk public/apk/app-dev.apk",
        "description": "构建连接本机后端的 Android 调试 APK，并复制到 apps/front/public/apk/app-dev.apk"
      },
      "staging": {
        "command": "cd apps/front && VERSION=${ANDROID_VERSION_NAME:-$(node -p \"require('./package.json').version\")} && VERSION_CODE=${ANDROID_VERSION_CODE:-$(date +%s)} && APP_ENV=staging NEXT_PUBLIC_APP_ENV=staging NEXT_CAPACITOR_BUILD=1 pnpm build:mobile && LANG=en_US.UTF-8 npx cap sync android && cd android && ANDROID_VERSION_NAME=$VERSION ANDROID_VERSION_CODE=$VERSION_CODE ./gradlew assembleRelease && cd .. && mkdir -p dist/mobile/staging && cp android/app/build/outputs/apk/release/app-release.apk dist/mobile/staging/app-staging.apk && cp android/app/build/outputs/apk/release/app-release.apk dist/mobile/staging/app-staging-$VERSION.apk",
        "description": "构建连接 Staging 后端的 Android Release APK，并输出到 apps/front/dist/mobile/staging/ 目录（含版本副本，已签名）"
      },
      "prod": {
        "command": "cd apps/front && VERSION=${ANDROID_VERSION_NAME:-$(node -p \"require('./package.json').version\")} && VERSION_CODE=${ANDROID_VERSION_CODE:-$(date +%s)} && APP_ENV=production NEXT_PUBLIC_APP_ENV=production NEXT_CAPACITOR_BUILD=1 pnpm build:mobile && LANG=en_US.UTF-8 npx cap sync android && cd android && ANDROID_VERSION_NAME=$VERSION ANDROID_VERSION_CODE=$VERSION_CODE ./gradlew assembleRelease && cd .. && mkdir -p dist/mobile/prod && cp android/app/build/outputs/apk/release/app-release.apk dist/mobile/prod/app-prod.apk && cp android/app/build/outputs/apk/release/app-release.apk dist/mobile/prod/app-prod-$VERSION.apk",
        "description": "构建连接生产后端的 Android Release APK，并输出到 apps/front/dist/mobile/prod/ 目录（含版本副本，已签名）"
      }
    },
    "all": {
      "dev": {
        "sequential": true,
        "commands": ["build.backend.dev", "build.sdk", "build.parallelWeb.dev"],
        "description": "构建所有应用(开发环境，Web并行)"
      },
      "prod": {
        "sequential": true,
        "commands": [
          "build.backend.prod",
          "build.sdk",
          "build.parallelWeb.prod"
        ],
        "description": "构建所有应用(生产环境，Web并行)"
      }
    },
    "parallelWeb": {
      "dev": {
        "concurrent": true,
        "commands": ["build.shared", "build.front.dev", "build.admin.dev"],
        "description": "并行构建 Web（shared/front/admin 开发环境）"
      },
      "prod": {
        "concurrent": true,
        "commands": ["build.shared", "build.front.prod", "build.admin.prod"],
        "description": "并行构建 Web（shared/front/admin 生产环境）"
      }
    },
    "sdk": {
      "dev": {
        "internal": "sdk-build",
        "args": ["dev"],
        "description": "构建 SDK（开发环境，默认在线）",
        "env": {
          "APP_ENV": "development"
        }
      },
      "staging": {
        "internal": "sdk-build",
        "args": ["dev"],
        "description": "构建 SDK（预发环境，默认在线）",
        "env": {
          "APP_ENV": "staging",
          "NODE_ENV": "production"
        }
      },
      "prod": {
        "internal": "sdk-build",
        "args": [],
        "description": "构建 SDK（生产环境，默认在线）",
        "env": {
          "APP_ENV": "production",
          "NODE_ENV": "production"
        }
      }
    },
    "affected": {
      "dev": {
        "command": "npx nx affected -t build --configuration=development --parallel=3",
        "description": "仅构建受影响项目(开发环境)"
      },
      "prod": {
        "command": "npx nx affected -t build --configuration=production --parallel=3",
        "description": "仅构建受影响项目(生产环境)"
      }
    }
  },
  "export": {
    "openapi": {
      "command": "pnpm --filter ./apps/backend run export:openapi",
      "app": "backend",
      "description": "导出 backend OpenAPI 规范"
    }
  },
  "deploy": {
    "front": {
      "description": "部署 front 到 Vercel"
    },
    "admin": {
      "description": "部署 admin 到 Vercel"
    },
    "telegram-bot": {
      "description": "部署 telegram-bot 到 Vercel 并自动配置 Webhook"
    },
    "all": {
      "description": "部署所有前端应用到 Vercel"
    }
  },
  "db": {
    "generate": {
      "command": "npx nx prisma:generate backend",
      "app": "backend",
      "description": "生成Prisma客户端"
    },
    "migrate": {
      "dev": {
        "command": "npx nx prisma:migrate:dev backend",
        "app": "backend",
        "description": "执行数据库迁移(开发环境)"
      },
      "e2e": {
        "command": "npx nx prisma:migrate:deploy backend",
        "app": "backend",
        "description": "执行数据库迁移(E2E测试环境)"
      },
      "prod": {
        "command": "npx nx prisma:migrate:deploy backend",
        "app": "backend",
        "dangerous": true,
        "description": "执行数据库迁移(生产环境)"
      }
    },
    "deploy": {
      "dev": {
        "command": "npx nx prisma:migrate:deploy backend",
        "app": "backend",
        "description": "应用数据库迁移(开发环境)"
      },
      "e2e": {
        "command": "npx nx prisma:migrate:deploy backend",
        "app": "backend",
        "description": "应用数据库迁移(E2E测试环境)"
      },
      "prod": {
        "command": "npx nx prisma:migrate:deploy backend",
        "app": "backend",
        "dangerous": true,
        "description": "应用数据库迁移(生产环境)"
      }
    },
    "reset": {
      "dev": {
        "command": "npx nx prisma:migrate:reset backend && npx nx prisma:db:seed backend",
        "app": "backend",
        "dangerous": true,
        "description": "重置数据库并填充种子数据(开发环境)"
      },
      "e2e": {
        "command": "npx nx prisma:migrate:reset backend && npx nx prisma:db:seed backend",
        "app": "backend",
        "dangerous": true,
        "description": "重置数据库并填充种子数据(E2E测试环境)"
      },
      "prod": {
        "command": "npx nx prisma:migrate:reset backend",
        "app": "backend",
        "dangerous": true,
        "description": "重置数据库(生产环境，不自动seed)"
      }
    },
    "seed": {
      "dev": {
        "command": "npx nx prisma:db:seed backend",
        "app": "backend",
        "description": "填充数据库(开发环境)"
      },
      "e2e": {
        "command": "npx nx prisma:db:seed backend",
        "app": "backend",
        "description": "填充数据库(E2E测试环境)"
      },
      "prod": {
        "command": "npx nx prisma:db:seed backend",
        "app": "backend",
        "description": "填充数据库(生产环境)"
      }
    },
    "format": {
      "command": "npx nx prisma:format backend",
      "description": "格式化Prisma schema文件"
    },
    "script": {
      "dev": {
        "command": "pnpm --filter ./apps/backend exec ts-node --swc -r tsconfig-paths/register prisma/scripts/{SCRIPT_NAME}.ts",
        "app": "backend",
        "description": "运行数据库脚本(开发环境)"
      },
      "prod": {
        "command": "pnpm --filter ./apps/backend exec ts-node --swc -r tsconfig-paths/register prisma/scripts/{SCRIPT_NAME}.ts",
        "app": "backend",
        "dangerous": true,
        "description": "运行数据库脚本(生产环境)"
      }
    }
  },
  "test": {
    "e2e": {
      "backend": {
        "command": "npx nx test:e2e backend",
        "app": "backend",
        "description": "运行后端E2E测试"
      },
      "all": {
        "command": "npx nx test:e2e backend",
        "app": "backend",
        "description": "运行所有E2E测试"
      }
    },
    "unit": {
      "backend": {
        "command": "npx nx test backend",
        "app": "backend",
        "description": "运行后端单元测试"
      }
    }
  },
  "lint": {
    "command": "npx nx run-many -t lint -- --max-warnings=2",
    "description": "运行代码检查（warnings 超过 2 个将报错）",
    "skipEnvValidation": true
  },
  "start": {
    "backend": {
      "dev": {
        "command": "npx nx dev backend",
        "app": "backend",
        "description": "启动后端开发服务（支持热重载）"
      },
      "prod": {
        "command": "npx nx start backend",
        "app": "backend",
        "description": "启动后端生产服务"
      }
    },
    "telegram-bot": {
      "dev": {
        "command": "pnpm --filter @ai/telegram-bot dev",
        "app": "telegram-bot",
        "ports": [3003],
        "description": "启动 Telegram Bot 开发服务"
      }
    },
    "dev": {
      "internal": "start-dev",
      "args": [],
      "description": "启动完整开发环境（集成start-dev.sh功能）",
      "interactive": true
    },
    "stagewise-front": {
      "command": "npx stagewise@latest -b -s -a 3001 -p 3002 -w ./apps/front",
      "description": "Stagewise 桥接 front (3001→3002)",
      "ports": [3002]
    },
    "stagewise-admin": {
      "command": "npx stagewise@latest -b -s -a 3500 -p 3501 -w ./apps/admin-front",
      "description": "Stagewise 桥接 admin-front (3500→3501)",
      "ports": [3501]
    }
  },
  "clean": {
    "all": {
      "command": "npx nx run-many -t clean",
      "description": "清理所有构建文件"
    },
    "deps": {
      "command": "rm -rf node_modules && pnpm install",
      "description": "清理并重新安装依赖",
      "dangerous": true
    }
  },
  "cache": {
    "clear": {
      "command": "set -e; npx nx reset; pnpm store prune || true; STORE_PATH=$(pnpm store path 2>/dev/null || echo ''); if [ -n \"$STORE_PATH\" ] && [ -d \"$STORE_PATH\" ]; then echo \"移除 PNPM store: $STORE_PATH\"; rm -rf \"$STORE_PATH\"; fi; rm -rf .nx/cache node_modules/.cache ~/.pnpm-store || true; echo 'Nx 与依赖缓存已清理'",
      "description": "清除 Nx 缓存与依赖库缓存 (pnpm store / 本地缓存)",
      "dangerous": true
    }
  },
  "install": {
    "command": "pnpm install --frozen-lockfile",
    "description": "安装依赖（使用 frozen-lockfile 确保版本一致）"
  }
}
